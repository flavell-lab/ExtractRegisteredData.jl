<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Registration-based neuron matching API · ExtractRegisteredData</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">ExtractRegisteredData</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">ExtractRegisteredData.jl Documentation</a></li><li><a class="tocitem" href="../extract/">Traces extraction API</a></li><li class="is-active"><a class="tocitem" href>Registration-based neuron matching API</a><ul class="internal"><li><a class="tocitem" href="#Commonly-used-functions"><span>Commonly used functions</span></a></li><li><a class="tocitem" href="#transformix-helper-functions"><span><code>transformix</code> helper functions</span></a></li><li><a class="tocitem" href="#Other-helper-functions"><span>Other helper functions</span></a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Registration-based neuron matching API</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Registration-based neuron matching API</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/flavell-lab/ExtractRegisteredData.jl/blob/master/docs/src/neuronmatch.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Registration-based-neuron-matching-API"><a class="docs-heading-anchor" href="#Registration-based-neuron-matching-API">Registration-based neuron matching API</a><a id="Registration-based-neuron-matching-API-1"></a><a class="docs-heading-anchor-permalink" href="#Registration-based-neuron-matching-API" title="Permalink"></a></h1><h2 id="Commonly-used-functions"><a class="docs-heading-anchor" href="#Commonly-used-functions">Commonly used functions</a><a id="Commonly-used-functions-1"></a><a class="docs-heading-anchor-permalink" href="#Commonly-used-functions" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-binding" id="ExtractRegisteredData.extract_roi_overlap" href="#ExtractRegisteredData.extract_roi_overlap"><code>ExtractRegisteredData.extract_roi_overlap</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">extract_roi_overlap(
    best_reg::Dict, param_path::Dict, param::Dict; reg_dir_key::String=&quot;path_dir_reg&quot;,
    transformed_dir_key::String=&quot;path_dir_transformed&quot;, reg_problems_key::String=&quot;path_reg_prob&quot;,
    param_path_moving::Union{Dict,Nothing}=nothing
)</code></pre><p>Extracts ROI overlaps and activity differences.</p><p><strong>Arguments</strong></p><ul><li><code>best_reg::Dict</code>: Dictionary of best registration values.</li><li><code>param_path::Dict</code>: Dictionary of paths to relevant files.</li><li><code>param::Dict</code>: Dictionary of parameter values.</li><li><code>reg_dir_key::String</code> (optional): Key in <code>param_path</code> corresponding to the registration directory. Default <code>path_dir_reg</code>.</li><li><code>transformed_dir_key::String</code> (optional): Key in <code>param_path</code> corresponding to the transformed ROI save directory. Default <code>path_dir_transformed</code>.</li><li><code>reg_problems_key::String</code> (optional): Key in <code>param_path</code> corresponding to the registration problems file. Default <code>path_reg_prob</code>.</li><li><code>param_path_moving::Union{Dict, Nothing}</code>: If set, the <code>param_path</code> dictionary corresponding to the moving dataset. Otherwise, the method will assume</li></ul><p>the moving and fixed datasets have the same path dictionary.</p></div></section></article><article class="docstring"><header><a class="docstring-binding" id="ExtractRegisteredData.make_regmap_matrix" href="#ExtractRegisteredData.make_regmap_matrix"><code>ExtractRegisteredData.make_regmap_matrix</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">make_regmap_matrix(
    roi_overlaps::Dict, roi_activity_diff::Dict, q_dict::Dict, best_reg::Dict, param::Dict;
    watershed_errors::Union{Nothing,Dict}=nothing, max_fixed_t::Int=0
)</code></pre><p>Assimilates ROIs from all time points and generates a quality-of-match matrix.</p><p><strong>Arguments</strong></p><ul><li><code>roi_overlaps::Dict</code>: a dictionary of dictionaries of ROI matches for each pair of moving and fixed time points</li><li><code>roi_activity_diff::Dict</code>: a dictionaon of dictionaries of the difference between normalized red ROI acivity, for each pair of moving and fixed time points</li><li><code>q_dict::Dict</code>: a dictionary of dictionaries of dictionaries of the registration quality for each metric for each resolution for each pair of moving and fixed time points</li><li><code>best_reg::Dict</code>: a dictionary of the registration that&#39;s being used, expressed as a tuple of resolutions, for each pair of moving and fixed time points</li><li><code>param::Dict</code>: a dictionary of parameter settings to use, including:<ul><li><code>activity_diff_threshold::Real</code>: parameter that controls how much red-channel activity differences are penalized in the matrix.</li></ul></li></ul><p>Smaller values = greater penalty. Default 0.3.     * <code>watershed_error_penalty::Real</code>: parameter that control how much watershed/UNet errors are penalized in the matrix. Smaller values = greater penalty. Default 0.5.     * <code>quality_metric</code>: metric to use in the <code>q_dict</code> parameter. Default <code>NCC</code>.     * <code>matrix_self_weight::Real</code>: amount of weight in the matrix to assign each ROI to itself. Default 0.5.     * <code>size_mismatch_penalty::Real</code>: penalty to apply to overlapping ROIs that don&#39;t fully overlap. Larger values = greater penalty. Default 2.</p><ul><li><code>watershed_errors::Union{Nothing, Dict}</code>: a dictionary of ROIs that might have had watershed or UNet errors for every time point.</li></ul><p>This dictionary must be pre-shifted if moving and fixed datasets are not the same. Ignored if nothing.</p><ul><li><code>max_fixed_t::Int</code>: If the moving and fixed datasets are not the same, this number is added to each moving dataset time point   to distinguish the datasets in the matrix and label map.</li></ul><p><strong>Returns</strong></p><ul><li><code>regmap_matrix</code>, a matrix whose <code>(i,j)</code>th entry encodes the quality of the match between ROIs <code>i</code> and <code>j</code>.</li><li><code>label_map</code>: a dictionary of dictionaries mapping original ROIs to new ROI labels, for each time point.</li></ul></div></section></article><article class="docstring"><header><a class="docstring-binding" id="ExtractRegisteredData.find_neurons" href="#ExtractRegisteredData.find_neurons"><code>ExtractRegisteredData.find_neurons</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">find_neurons(regmap_matrix, label_map::Dict, param::Dict)</code></pre><p>Groups ROIs into neurons based on a matrix of overlaps.</p><p><strong>Arguments:</strong></p><ul><li><code>regmap_matrix</code>: Matrix of distances between the ROIs</li><li><code>label_map::Dict</code>: Dictionary of dictionaries mapping original ROIs to new ROI labels, for each time point.</li><li><code>param::Dict</code>: Dictionary containing <code>cluster_overlap_thresh</code> and <code>cluster_height_thresh</code> parameter settings to use for clustering. </li></ul><p><strong>Returns</strong></p><ul><li><code>new_label_map</code>: Dictionary of dictionaries mapping original ROIs to neuron labels, for each time point.</li><li><code>inv_map</code>: Dictionary of dictionaries mapping time points to original ROIs, for each neuron label</li><li><code>hmer</code>: Raw clusters of the dataset.</li></ul></div></section></article><article class="docstring"><header><a class="docstring-binding" id="ExtractRegisteredData.register_immobilized_rois" href="#ExtractRegisteredData.register_immobilized_rois"><code>ExtractRegisteredData.register_immobilized_rois</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">register_immobilized_rois(regmap_matrix, label_map_regmap, inv_map_regmap, label_map_freelymoving, valid_rois_freelymoving, param, reg_timept)</code></pre><p>Registers immobilized ROIs to the freely moving dataset.</p><p><strong>Arguments:</strong></p><ul><li><code>regmap_matrix</code>: Matrix of distances between the ROIs</li><li><code>label_map_regmap::Dict</code>: Dictionary of dictionaries mapping original ROIs to new ROI labels for the freely-moving-to-immobilized registration.</li><li><code>inv_map_regmap::Dict</code>: Dictionary of dictionaries mapping new ROI labels to original ROIs, for the freely-moving-to-immobilized registration.</li><li><code>label_map_freelymoving::Dict</code>: Dictionary of dictionaries mapping original ROIs to new ROI labels in the freely-moving dataset (one of the outputs of <code>find_neurons</code>).</li><li><code>valid_rois_freelymoving</code>: List of which ROIs correspond to neurons in the freely-moving dataset.</li><li><code>param::Dict</code>: Dictionary containing <code>max_t</code> parameter setting to use for registration.</li><li><code>reg_timept</code>: Time point of the immobilized dataset to register.</li></ul><p><strong>Returns:</strong></p><ul><li><code>roi_matches</code>: Dictionary of dictionaries mapping immobilized ROIs to matched freely moving ROIs.</li><li><code>inv_matches</code>: Dictionary of dictionaries mapping matched freely moving ROIs to immobilized ROIs.</li><li><code>roi_matches_best</code>: Dictionary of dictionaries mapping immobilized ROIs to matched freely moving ROIs, with only the best match for each immobilized ROI.</li><li><code>roi_match_confidence</code>: Dictionary of dictionaries mapping immobilized ROIs to the confidence of the match.</li></ul></div></section></article><article class="docstring"><header><a class="docstring-binding" id="ExtractRegisteredData.invert_label_map" href="#ExtractRegisteredData.invert_label_map"><code>ExtractRegisteredData.invert_label_map</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">invert_label_map(label_map)</code></pre><p>Inverts ROI label map <code>label_map</code>, so that new ROIs map back to dictionaries mapping original time points to original ROIs.</p></div></section></article><h2 id="transformix-helper-functions"><a class="docs-heading-anchor" href="#transformix-helper-functions"><code>transformix</code> helper functions</a><a id="transformix-helper-functions-1"></a><a class="docs-heading-anchor-permalink" href="#transformix-helper-functions" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-binding" id="ExtractRegisteredData.run_transformix_centroids" href="#ExtractRegisteredData.run_transformix_centroids"><code>ExtractRegisteredData.run_transformix_centroids</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">run_transformix_centroids(path, output, centroids, parameters, transformix_dir)</code></pre><p>Runs transformix to map centroids from the fixed volume to the moving volume. Note that this is the opposite of <code>run_transformix_roi</code>, because of the way <code>transformix</code> is implemented.</p><p><strong>Arguments</strong></p><ul><li><code>path::String</code>: Path to directory containing elastix registration</li><li><code>output::String</code>: Output file directory</li><li><code>centroids</code>: File containing centroids to transform</li><li><code>parameters::String</code>: Transform parameter file</li><li><code>transformix_dir::String</code>: Path to <code>transformix</code> executable</li></ul></div></section></article><article class="docstring"><header><a class="docstring-binding" id="ExtractRegisteredData.run_transformix_roi" href="#ExtractRegisteredData.run_transformix_roi"><code>ExtractRegisteredData.run_transformix_roi</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">run_transformix_roi(path::String, input::String, output::String, parameters::String, parameters_roi::String, transformix_dir::String)</code></pre><p>Runs transformix to map an ROI image from the moving volume to the fixed volume.  Modifies various transform parameters to force nearest-neighbors interpolation. Returns the resulting transformed image. Note that this is the opposite of <code>run_transformix_centroids</code>, because of the way <code>transformix</code> is implemented.</p><p><strong>Arguments</strong></p><ul><li><code>path::String</code>: Path to directory containing elastix registration. Other paths should be absolute; they are NOT relative to this.</li><li><code>input::String</code>: Input file path</li><li><code>output::String</code>: Output file directory path</li><li><code>parameters::String</code>: Path to transform parameter file</li><li><code>parameters_roi::String</code>: Filename to save modified parameters.</li><li><code>transformix_dir::String</code>: Path to <code>transformix</code> executable</li></ul></div></section></article><article class="docstring"><header><a class="docstring-binding" id="ExtractRegisteredData.run_transformix_img" href="#ExtractRegisteredData.run_transformix_img"><code>ExtractRegisteredData.run_transformix_img</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">run_transformix_img(path::String, output::String, input::String, parameters::String, parameters_roi::String, transformix_dir::String; interpolation_degree::Int=1)</code></pre><p>Runs transformix to map an image from the moving volume to the fixed volume.  Returns the resulting transformed image. Note that this is the opposite of <code>run_transformix_centroids</code>, because of the way <code>transformix</code> is implemented.</p><p><strong>Arguments</strong></p><ul><li><code>path::String</code>: Path to directory containing elastix registration</li><li><code>output::String</code>: Output file directory</li><li><code>input::String</code>: Input file path</li><li><code>parameters::String</code>: Transform parameter file</li><li><code>transformix_dir::String</code>: Path to <code>transformix</code> executable</li><li><code>interpolation_degree::Int</code> (optional): Interpolation degree. Default 1 (linear interpolation).</li></ul></div></section></article><h2 id="Other-helper-functions"><a class="docs-heading-anchor" href="#Other-helper-functions">Other helper functions</a><a id="Other-helper-functions-1"></a><a class="docs-heading-anchor-permalink" href="#Other-helper-functions" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-binding" id="ExtractRegisteredData.pairwise_dist" href="#ExtractRegisteredData.pairwise_dist"><code>ExtractRegisteredData.pairwise_dist</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">pairwise_dist(regmap_matrix; threshold::Real=1e-16, dtype::Type=Float64)</code></pre><p>Finds the distances between each pair of ROIs based on similarity between rows of the <code>regmap_matrix</code>.</p><p><strong>Arguments</strong></p><ul><li><code>regmap_matrix</code>: matrix of registration matches</li></ul><p><strong>Optional keyword arguments</strong></p><ul><li><code>threshold::Real</code>: a small number added to the denominator to ensure there are no divide-by-zero errors. Default 1e-16.</li><li><code>dtype::Type</code>: Data type of matrix. Default Float64.</li></ul></div></section></article><article class="docstring"><header><a class="docstring-binding" id="ExtractRegisteredData.register_neurons_overlap" href="#ExtractRegisteredData.register_neurons_overlap"><code>ExtractRegisteredData.register_neurons_overlap</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">register_neurons_overlap(roi_inferred, roi, activity_inferred, activity)</code></pre><p>Matches ROIs from registered time points together based on the overlap heuristic.</p><p><strong>Arguments</strong></p><ul><li><code>inferred_roi</code>: ROI image array from the moving volume that has had the registration applied to it (eg via <code>transformix</code>)</li><li><code>roi</code>: ROI image array from the fixed time point</li><li><code>inferred_activity</code>: array of activities of each ROI in the marker channel from the moving time point</li><li><code>activity</code>: array of activities of each ROI in the marker channel from the fixed time point</li></ul><p><strong>Returns</strong></p><ul><li><p><code>overlapping_rois</code>: a dictionary of ROI matches between the moving and fixed volumes.   The values of the dictionary are the amount of overlap as a fraction of total ROI size.   Eg: if ROI 15 in the moving volume has size 100, ROI 10 in the fixed volume has size 80, and the overlap has size 50,   <code>(15, 10) =&gt; (0.5, 0.625)</code> would be an entry in the dictionary.</p></li><li><p><code>activity_mismatch</code>: a dictionary of the differences between the normalized activity of the ROIs   between the moving and fixed time points.</p></li></ul></div></section></article><article class="docstring"><header><a class="docstring-binding" id="ExtractRegisteredData.update_label_map" href="#ExtractRegisteredData.update_label_map"><code>ExtractRegisteredData.update_label_map</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">update_label_map(label_map, matches)</code></pre><p>Updates ROI label map <code>label_map</code> to include ROI matches <code>matches</code>, and returns updated version.</p></div></section></article><article class="docstring"><header><a class="docstring-binding" id="ExtractRegisteredData.delete_smeared_neurons" href="#ExtractRegisteredData.delete_smeared_neurons"><code>ExtractRegisteredData.delete_smeared_neurons</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">delete_smeared_neurons(roi, threshold)</code></pre><p>Deletes neurons that might come from huge deformations in registration from an <code>roi</code> (neurons that have more pixels than <code>threshold</code>).</p></div></section></article><article class="docstring"><header><a class="docstring-binding" id="ExtractRegisteredData.merge_confocal_data!" href="#ExtractRegisteredData.merge_confocal_data!"><code>ExtractRegisteredData.merge_confocal_data!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">merge_confocal_data!(combined_data_dict::Dict, data_dict::Dict, data_dict_2::Dict, dataset::String; traces_key=&quot;traces_array&quot;, zscored_traces_key=&quot;raw_zscored_traces_array&quot;, F_F20_key=&quot;traces_array_F_F20&quot;)</code></pre><p>This function merges neuron identities from two datasets from the same animal, <code>data_dict</code> and <code>data_dict_2</code>, into a new dictionary <code>combined_data_dict</code>. The function is used to combine data from two different datasets.</p><p><strong>Arguments</strong></p><ul><li><code>combined_data_dict::Dict</code>: A dictionary that will contain the merged data.</li><li><code>data_dict::Dict</code>: A dictionary containing the first dataset to be merged.</li><li><code>data_dict_2::Dict</code>: A dictionary containing the second dataset to be merged.</li><li><code>dataset::String</code>: A string representing the name of the second dataset in the first dataset&#39;s dictionray.</li><li><code>traces_key::String</code>: A string representing the key for the traces array in the dictionaries. Default is &quot;traces_array&quot;.</li><li><code>zscored_traces_key::String</code>: A string representing the key for the zscored traces array in the dictionaries. Default is &quot;raw<em>zscored</em>traces_array&quot;.</li><li><code>F_F20_key::String</code>: A string representing the key for the F/F0 traces array in the dictionaries. Default is &quot;traces<em>array</em>F_F20&quot;.</li></ul><p>The function returns nothing, but modifies the <code>combined_data_dict</code> dictionary in place.</p></div></section></article><article class="docstring"><header><a class="docstring-binding" id="ExtractRegisteredData.match_neurons_across_datasets" href="#ExtractRegisteredData.match_neurons_across_datasets"><code>ExtractRegisteredData.match_neurons_across_datasets</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">match_neurons_across_datasets(label_map_1::Dict, label_map_2::Dict, inv_map_reg::Dict, max_fixed_t::Int)</code></pre><p>Matches neurons across multiple datasets.</p><p><strong>Arguments</strong></p><ul><li><code>label_map_1::Dict</code>: Label map of ROI/time points to neuron ID for dataset 1.</li><li><code>label_map_2::Dict</code>: Label map of ROI/time points to neuron ID for dataset 2.</li><li><code>inv_map-reg::Dict</code>: Map of neuron ID to ROI/time points for the registration between datasets. Time points in dataset 2 are shifted by <code>max_fixed_t</code>.</li><li><code>max_fixed_t::Int</code>: Maximum time point in the first dataset.</li></ul></div></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../extract/">« Traces extraction API</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Tuesday 11 July 2023 22:09">Tuesday 11 July 2023</span>. Using Julia version 1.9.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
